# Verkkosovellus kolmikerrosarkkitehtuurilla

<link href="/styles.css" rel="stylesheet">

[â‡¦ takaisin kurssin etusivulle](../)

TÃ¤llÃ¤ viikolla tavoitteinamme on rakentaa kolmikerrosarkkitehtuuria noudattava web-sovellus, joka yhdistÃ¤Ã¤ tÃ¤hÃ¤n mennessÃ¤ opettelemamme erilliset tietokanta- ja web-teknologiat yhdeksi loogiseksi kokonaisuudeksi.

Jatkat siis tÃ¤llÃ¤ viikolla edellisellÃ¤ viikolla aloittamasi web-projektin kehittÃ¤mistÃ¤ ja tarvitset myÃ¶s aikaisempia shopping list -tietokantaluokkiasi. MikÃ¤li aikaisemmat tehtÃ¤vÃ¤t ovat jÃ¤Ã¤neet sinulta kesken, voit hyÃ¶dyntÃ¤Ã¤ tÃ¤llÃ¤ viikolla myÃ¶s kurssin malliratkaisuja, jotka on julkaistu edellisten tehtÃ¤vien mÃ¤Ã¤rÃ¤aikojen pÃ¤Ã¤tyttyÃ¤ kurssin Teams-kanavalla.


## Sovelluksemme arkkitehtuuri

Sovellusten kehitettÃ¤vyyden ja yllÃ¤pidettÃ¤vyyden kannalta on tÃ¤rkeÃ¤Ã¤, ettÃ¤ ne noudattavat jotain tiettyÃ¤ arkkitehtuuria ja ettÃ¤ niissÃ¤ erilliset loogiset kokonaisuudet on toteutettu toisistaan irrallaan. MeidÃ¤n ostoslistasovelluksessamme noudatamme kolmikerrosarkkitehtuuria ja MVC-mallia:

> *"Ammattilaisten kehittÃ¤mÃ¤ sovellus ei ole pelkkÃ¤ satunnainen kasa koodia, vaan rakentuu valittujen arkkitehtuurimallien ympÃ¤rille. Arkkitehtuuri auttaa pitÃ¤mÃ¤Ã¤n sovelluksen sisÃ¤isen rakenteen loogisena ja helpottaa sovelluksen yllÃ¤pidettÃ¤vyyttÃ¤ ja jatkokehitettÃ¤vyyttÃ¤.*
>
> *Model-View-Controller (MVC) on perinteinen ohjelmistokehityksen suunnittelumalli, jonka tÃ¤rkein tehtÃ¤vÃ¤ on eriyttÃ¤Ã¤ sovelluksen esitys- ja logiikkakerros toisistaan ja delegoida sovelluksen sisÃ¤isiÃ¤ vastuita eri osa-alueille."*
>
> [Hurja.fi, 2020. MVC for dummies: malli, nÃ¤kymÃ¤ ja ohjain -arkkitehtuuri web-sovelluksissa](https://www.hurja.fi/blogi/mvc-for-dummies-malli-nakyma-ja-ohjain-arkkitehtuuri-web-sovelluksissa/)

Model-View-Controller -suunnittelumallissa (MVC) sovelluksen eri vastuualueet eriytetÃ¤Ã¤n toisistaan sovelluksen sisÃ¤llÃ¤ kolmikerrosarkkitehtuurin mukaisesti malleihin (models), nÃ¤kymiin (views) ja ohjauslogiikkaan (controllers).

TÃ¤mÃ¤ suunnittelumalli on tyypillinen erityisesti olio-ohjelmointiparadigmaa noudattavissa web-sovelluksissa ja suosittelen lukemaan aiheesta blogikirjoituksen ["MVC for dummies: malli, nÃ¤kymÃ¤ ja ohjain -arkkitehtuuri web-sovelluksissa" (Hurja, 2020)](https://www.hurja.fi/blogi/mvc-for-dummies-malli-nakyma-ja-ohjain-arkkitehtuuri-web-sovelluksissa/).

NÃ¤iden arkkitehtuurimallien mukaisesti sovelluksemme kolme osakokonaisuutta ovat siis:

1. datan tallennuskerros (model: dao, jdbc ja SQLite)
2. kÃ¤yttÃ¶liittymÃ¤kerros (view: jsp ja jstl)
3. looginen kerros (controller: servlet)

Seuraavissa kappaleissa ja videoissa kÃ¤sittelemme jo aikaisemmin toteuttamamme datan tallennuskerroksen tuomisen osaksi web-sovellustamme.


## Projektipohja

TÃ¤llÃ¤ viikolla tarkoituksena on jatkaa web-sovelluksen kehittÃ¤mistÃ¤ viime viikolla kÃ¤yttÃ¤mÃ¤Ã¤si projektipohjaan. MikÃ¤li edellinen tehtÃ¤vÃ¤ jÃ¤i sinulta ratkaisematta tai haluat aloittaa puhtaalta pÃ¶ydÃ¤ltÃ¤, voit kloonata itsellesi uuden kopion [kurssin projektipohjasta](https://github.com/ohjelmointi2/embedded-tomcat-template) edellisen viikon ohjevideoiden mukaisesti. 

ğŸ’¡ *Jos kloonaat projektipohjan uudelleen, nimeÃ¤ ensin nykyinen projektisi EclipsessÃ¤ uudelleen, koska Eclipse-tyÃ¶tilassa ei voi olla kahta samannimistÃ¤ projektia.*


## DAO- ja Model-luokkien lisÃ¤Ã¤minen projektiin

Olet aikaisemmassa tehtÃ¤vÃ¤ssÃ¤ luonut `ShoppingListITem`-luokan, joka mallintaa yksittÃ¤isiÃ¤ tietokannassa olevia rivejÃ¤. Olet lisÃ¤ksi luonut DAO-luokan, jonka avulla pystyt tekemÃ¤Ã¤n CRUD-operaatioita tietokantaasi (CRUD = Create, Read, Update, Delete).

Saat valmiit luokat helpoiten kÃ¤yttÃ¶Ã¶n web-projektissasi kopioimalla luokkien pakettirakenteen web-projektiisi `src/main/java`-hakemiston alle. Mahdollisesti toteuttamasi JUnit-testiluokat puolestaan kuuluvat `src/test/java`-hakemiston alle.

Ohjelmasi hakemistorakenne voi olla luokkien lisÃ¤Ã¤misen jÃ¤lkeen esimerkiksi seuraava:

```
pom.xml
src
 â”œâ”€â”€â”€main
 â”‚   â”œâ”€â”€â”€java
 â”‚   â”‚   â”œâ”€â”€â”€database
 â”‚   â”‚   â”‚       JDBCShoppingListItemDao.java
 â”‚   â”‚   â”‚       ShoppingListItemDao.java
 â”‚   â”‚   â”‚       Database.java *
 â”‚   â”‚   â”‚
 â”‚   â”‚   â”œâ”€â”€â”€launch
 â”‚   â”‚   â”‚       Main.java
 â”‚   â”‚   â”‚
 â”‚   â”‚   â”œâ”€â”€â”€model
 â”‚   â”‚   â”‚       ShoppingListItem.java
 â”‚   â”‚   â”‚
 â”‚   â”‚   â””â”€â”€â”€servlet
 â”‚   â”‚           ShoppingListServlet.java **
 â”‚   â”‚
 â”‚   â””â”€â”€â”€webapp
 â”‚       â”œâ”€â”€â”€styles
 â”‚       â”‚       demo.css
 â”‚       â”‚
 â”‚       â””â”€â”€â”€WEB-INF
 â”‚               list.jsp **
 â”‚
 â””â”€â”€â”€test
     â””â”€â”€â”€java
         â””â”€â”€â”€database
                 JDBCShoppingListItemDaoTest.java *

---------------------------------------------------

*  toteutettu vapaaehtoisena tehtÃ¤vÃ¤nÃ¤
** luodaan tÃ¤llÃ¤ harjoituskierroksella
```

**YmpÃ¤ristÃ¶muuttujan lisÃ¤Ã¤minen**

MikÃ¤li toteutit DAO-tehtÃ¤vÃ¤n bonus-osuuden ja kÃ¤ytit `JDBCShoppingListItemDao`-luokkasi kanssa `JDBC_DATABASE_URL`-ympÃ¤ristÃ¶muuttujaa, mÃ¤Ã¤rittele sama ympÃ¤ristÃ¶muuttuja myÃ¶s web-projektin `Main`-luokan ympÃ¤ristÃ¶muuttujiin. Eclipsen ympÃ¤ristÃ¶muuttujat ovat luokkakohtaisia ja aikaisempi ympÃ¤ristÃ¶muuttujasi ei ole automaattisesti `Main`-luokan kÃ¤ytettÃ¤vissÃ¤.

Ohjeet muuttujan asettamiseksi lÃ¶ydÃ¤t myÃ¶s seuraavalta videolta.


## Video 1: [Tietokantaluokkien tuominen web-sovellukseen](https://web.microsoftstream.com/video/3998be63-0576-44e2-8e05-fb3da6008789) <small>10:33</small>

<iframe width="640" height="360" src="https://web.microsoftstream.com/embed/video/3998be63-0576-44e2-8e05-fb3da6008789?autoplay=false&amp;showinfo=true" allowfullscreen style="border:none;"></iframe>

TÃ¤ssÃ¤ videossa lisÃ¤Ã¤mme verkkopalveluumme aikaisemmalla viikolla toteuttamamme tietokantaluokat. LisÃ¤Ã¤mme `Main`-luokallemme `JDBC_DATABASE_URL`-ympÃ¤ristÃ¶muuttujan, jonka avulla verkkosovellus hyÃ¶dyntÃ¤Ã¤ samaa tietokantaa kuin aikaisempi tekstikÃ¤yttÃ¶liittymÃ¤mme.

TÃ¤llÃ¤ videolla esiintyvÃ¤t lÃ¤hdekoodit lÃ¶ydÃ¤t JDBC ja DAO -tehtÃ¤vien malliratkaisuista Teamsissa.

&nbsp;



## Riippuvuuksien asentaminen

Omien lÃ¤hdekooditiedostojemme lisÃ¤ksi tarvitsemme web-projektiimme sen ulkoiset riippuvuudet, eli SQLite-ajurin ja JUnit-testikirjaston. Kuten viime viikon materiaalissa totesimme, projektipohjassa on valmiiksi kÃ¤ytÃ¶ssÃ¤ Maven-automaatiotyÃ¶kalu riippuvuuksien hallitsemiseksi. 

Aikaisempien riippuvuuksien ja uuden JSTL-tagikirjaston (JSP Standard Tag Library) asennus sujuu helpoiten lisÃ¤Ã¤mÃ¤llÃ¤ ne riippuvuuksina Mavenin hyÃ¶dyntÃ¤mÃ¤Ã¤n `pom.xml`-tiedostoon.

<!--Toinen vaihtoehto olisi tallentaa riippuvuudet .jar-paketteina (Java Archive), kuten aikaisemmin tÃ¤llÃ¤ kurssilla teimme SQLite-kirjaston kanssa.-->


### Riippuvuuksien mÃ¤Ã¤rittely pom.xml:Ã¤Ã¤n (Project Object Model)

Tomcat-projektipohjan juurihakemistossa sijaitseva `pom.xml`-projektitiedosto on normaali XML-tiedosto, jota voit muokata esimerkiksi Eclipsen tekstieditorilla. Avatessasi tiedostoa Eclipse saattaa avata sen "Overview"-nÃ¤kymÃ¤ssÃ¤, jolloin voit vaihtaa nÃ¤kymÃ¤n klikkaamalla sen alalaidan `pom.xml`-vÃ¤lilehteÃ¤ [tÃ¤mÃ¤n videon mukaisesti](https://javavids.com/video/open-xml-in-pomxml-by-default-in-eclipse).

TehdessÃ¤si muutoksia ja tallentaessasi tiedoston Eclipsen Maven-lisÃ¤osa asentaa automaattisesti uudet riippuvuudet projektiisi.

### Versionumeroiden mÃ¤Ã¤ritteleminen

Riippuvuuksien versionumerot on tapana mÃ¤Ã¤ritellÃ¤ projektitiedostoon `<properties>`-tagin sisÃ¤Ã¤n ja itse riippuvuudet `<dependencies>`-tagin sisÃ¤Ã¤n. LisÃ¤Ã¤ vihreÃ¤llÃ¤ korostetut rivit pom.xml-tiedostoosi properties-tagin sisÃ¤Ã¤n:

<pre>
&lt;properties&gt;
    &lt;!-- Tomcatin versionumero --&gt;
    &lt;tomcat.version&gt;8.5.73&lt;/tomcat.version&gt;

    &lt;!-- Javan versionumero --&gt;
    &lt;maven.compiler.target&gt;11&lt;/maven.compiler.target&gt;
    &lt;maven.compiler.source&gt;11&lt;/maven.compiler.source&gt;

    &lt;!-- JUnit-testikirjaston versio --&gt;
    &lt;junit.jupiter.version&gt;5.7.1&lt;/junit.jupiter.version&gt;
<span style="color: darkgreen; font-weight: bold;">
    &lt;!-- lis&auml;&auml; n&auml;m&auml; rivit: --&gt;
    &lt;sqlite.driver.version&gt;3.36.0.3&lt;/sqlite.driver.version&gt;
    &lt;jstl.api.version&gt;1.2&lt;/jstl.api.version&gt;
</span>
    &lt;!-- Projektin merkist&ouml;koodaus --&gt;
    &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;
    &lt;project.reporting.outputEncoding&gt;UTF-8&lt;/project.reporting.outputEncoding&gt;
</pre>

LisÃ¤Ã¤mÃ¤si tagit mÃ¤Ã¤rittelevÃ¤t seuraavat uudet muuttujat versionumeroita varten:

Muuttuja                | Versionumero  | Tarkoitus
------------------------|---------------|----------
`sqlite.driver.version` | 3.36.0.3      | Aikaisemmilta viikoilta tuttu SQLite-ajuri JDBC-kirjastolle
`jstl.api.version`      | 1.2           | JSTL-tagikirjasto

NÃ¤itÃ¤ muuttujia voidaan hyÃ¶dyntÃ¤Ã¤ alempana riippuvuuksia mÃ¤Ã¤riteltÃ¤essÃ¤. Riippuvuudet mÃ¤Ã¤ritellÃ¤Ã¤n `<dependencies>`-tagin sisÃ¤Ã¤n, kukin riippuvuus omana `<dependency>`-tagina. LisÃ¤Ã¤ seuraavat plus-merkein korostetut riippuvuudet dependencies-tagin loppuun:


<pre>
&lt;!-- Tiedoston alkuosa j&auml;tetty pois... --&gt;

    &lt;!-- JUnit-testausty&ouml;kalu --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.junit.jupiter&lt;/groupId&gt;
        &lt;artifactId&gt;junit-jupiter&lt;/artifactId&gt;
        &lt;version&gt;${junit.jupiter.version}&lt;/version&gt;
        &lt;scope&gt;test&lt;/scope&gt;
    &lt;/dependency&gt;
<span style="color: darkgreen; font-weight: bold;">
    &lt;!-- lis&auml;&auml; n&auml;m&auml; riippuvuudet (SQLite ja JSTL): --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.xerial&lt;/groupId&gt;
        &lt;artifactId&gt;sqlite-jdbc&lt;/artifactId&gt;
        &lt;version&gt;${sqlite.driver.version}&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;javax.servlet&lt;/groupId&gt;
        &lt;artifactId&gt;jstl&lt;/artifactId&gt;
        &lt;version&gt;${jstl.api.version}&lt;/version&gt;
    &lt;/dependency&gt;
</span>&lt;/dependencies&gt;
</pre>

**Huom!** Esimerkkikoodien vihreiden rivien vasemmassa laidassa olevat plus-merkit (`+`) ovat osa muuttuneita rivejÃ¤ korostavaa diff-syntaksia, jotka eivÃ¤t kuulu mukaan pom-tiedostoon. 

Tallennettuasi muutetun `pom.xml`-tiedoston Eclipse kÃ¤ynnistÃ¤Ã¤ Maven-pluginin asentaakseen uudet riippuvuudet. Varmuuden vuoksi aina tÃ¤mÃ¤n tiedoston muokkaamisen jÃ¤lkeen kannattaa vielÃ¤ klikata projektia Eclipsen hakemistopuussa hiiren kakkospainikkeella ja valita [Maven-valikosta kohta "Update Project"](https://stackoverflow.com/a/20547404).


## JSTL (JSP Standard Tag Library)

Dynaamisten ominaisuuksien, kuten ehto- ja toistorakenteiden toteuttaminen JSP-sivuilla onnistuu kÃ¤tevimmin hyÃ¶dyntÃ¤en edellÃ¤ projektiimme lisÃ¤ttyÃ¤ JSTL-kirjastoa. JSTL-kirjaston avulla esimerkiksi ehto- ja toistorakenteet voidaan toteuttaa JSP-sivuille XML-muotoisten tagien avulla (`c:if`- ja `c:forEach`-tagit). JSTL-kirjaston avulla voimme myÃ¶s turvallisesti nÃ¤yttÃ¤Ã¤ sivulla syÃ¶tteinÃ¤ saatuja merkkijonoja, jotka saattavat sisÃ¤ltÃ¤Ã¤ haitallista HTML-koodia (`c:out`-tagi).

Katso seuraava video, jossa esitellÃ¤Ã¤n tagikirjaston kÃ¤yttÃ¶Ã¶notto sekÃ¤ sen keskeisiÃ¤ tageja:

**YouTube: [JSTL Tutorial part 2 Core Tags](https://youtu.be/R0EnI9_ZMA0)**

<!--[![JSTL Tutorial part 2 Core Tags](https://img.youtube.com/vi/R0EnI9_ZMA0/hq1.jpg)](https://youtu.be/R0EnI9_ZMA0)-->

> *TÃ¤mÃ¤ video esittelee, miten JSTL tagikirjasto lisÃ¤tÃ¤Ã¤n JSP-sivulle `taglib`-direktiivin avulla. Opit myÃ¶s kÃ¤yttÃ¤mÃ¤Ã¤n `c:out` ja `c:forEach` tageja. Video nÃ¤yttÃ¤Ã¤ myÃ¶s konkreettisesti, miten lista olioita voidaan vÃ¤littÃ¤Ã¤ servletiltÃ¤ JSP-sivulle ja miten sillÃ¤ olevat Java-oliot saadaan esitettyÃ¤ sivulla HTML-muodossa. Video on jatkoa viime viikon videolle [JSTL tutorial part 1](https://youtu.be/KmREMEhj5eE).*


## Video 2: [Tietokantapohjaisen servletin toteuttaminen ja tulosten nÃ¤yttÃ¤minen JSP-sivulla](https://web.microsoftstream.com/video/515b523d-bc9b-4892-a2cf-78e75206e9a9) <small>58:31</small>

Seuraavalla videolla lisÃ¤Ã¤mme verkkopalvelumme tarvitsemat riippuvuudet ohjeen mukaisesti Maven-tyÃ¶kalun avulla. Tietokantaluokat kopioidaan aikaisemmista harjoituksistamme ja kopioinnin onnistuminen varmistetaan yksikkÃ¶testeillÃ¤.

Lopulta nÃ¤ytÃ¤mme tietokannasta lÃ¶ytyvÃ¤t ostoslistan rivit HTML-muodossa JSP-sivulla.

<iframe width="640" height="360" src="https://web.microsoftstream.com/embed/video/515b523d-bc9b-4892-a2cf-78e75206e9a9?autoplay=false&amp;showinfo=true" allowfullscreen style="border:none;"></iframe>

Videolla esitellÃ¤Ã¤n kohdassa **15:30** tyypillinen ongelma Tomcatin kÃ¤ynnistÃ¤misessÃ¤, joka johtuu siitÃ¤, ettÃ¤ vanha Tomcat-suoritus on edelleen kÃ¤ynnissÃ¤ taustalla.

TÃ¤rkeÃ¤ aihe web-palvelun suojaamiseksi haitallisilta JavaScript-koodeilta ([Cross Site Scripting, XSS](https://owasp.org/www-community/attacks/xss/)) esitellÃ¤Ã¤n videolla kohdassa **44:13**.

ğŸ’¡ *Videolla projektiin lisÃ¤tÃ¤Ã¤n kolme riippuvuutta, joista `org.junit.jupiter` tulee projektipohjan nykyisessÃ¤ versiossa valmiina. SitÃ¤ ei siis tarvitse lisÃ¤tÃ¤ enÃ¤Ã¤ tÃ¤mÃ¤n videon mukaisesti.*

&nbsp;

<!--Videolla muokattavan [pom.xml-tiedoston, ShoppingListServlet-luokan ja list.jsp-tiedoston lÃ¤hdekoodit lÃ¶ydÃ¤t tÃ¤Ã¤ltÃ¤](https://gist.github.com/swd1tn002/c2adb55f198846d6f44bf6d96275dead).-->


## Video 3: [JSP-sivujen ehtorakenteet ja "fail silently"-ominaisuus](https://web.microsoftstream.com/video/d4adda6c-9b93-4a0a-a92a-57067f3493fb) <small>31:21</small>

<iframe width="640" height="360" src="https://web.microsoftstream.com/embed/video/d4adda6c-9b93-4a0a-a92a-57067f3493fb?autoplay=false&amp;showinfo=true" allowfullscreen style="border:none;"></iframe>

TÃ¤llÃ¤ videolla toteutamme servletin, joka vÃ¤littÃ¤Ã¤ JSP-sivulle useita attribuutteja. Tutustumme myÃ¶s `c:if`-ehtorakenteisiin ja JSP-sivujen virheenkÃ¤sittelyyn. 

<!--Videolla kÃ¤siteltÃ¤vÃ¤n [SummerCountdownServlet.java-luokan ja countdown.jsp-sivun lÃ¶ydÃ¤t tÃ¤Ã¤ltÃ¤](https://gist.github.com/swd1tn002/1a9eac1b32179a8411e6f611ef0f731a).-->

&nbsp;


## TehtÃ¤vÃ¤t

NÃ¤issÃ¤ tehtÃ¤vissÃ¤ tarvitset aikaisempina viikkoina toteutettuja tietokantaluokkia. MikÃ¤li tehtÃ¤vÃ¤t jÃ¤ivÃ¤t sinulta kesken tai et ole tyytyvÃ¤inen koodisi toimintaan, voit kÃ¤yttÃ¤Ã¤ tehtÃ¤vÃ¤n pohjana malliratkaisun lÃ¤hdekoodeja, jotka julkaistaan kurssin Teams-kanavalla tehtÃ¤vien mÃ¤Ã¤rÃ¤ajan pÃ¤Ã¤tyttyÃ¤.

**TehtÃ¤vÃ¤t liittyvÃ¤t vahvasti edellÃ¤ esitettyihin videoihin, joten videoiden katsominen on erittÃ¤in suositeltavaa.**


### Osa 1: Toteuta ostoslistan sisÃ¤llÃ¶n hakeva servletti ja sen `doGet`-metodi

Tarvitset ostoslistan esittÃ¤mistÃ¤ varten uuden servletin, joka voi lÃ¶ytyÃ¤ palvelimeltasi esimerkiksi polusta (`/list`). Voit vapaasti valita haluamasi polun, joka mÃ¤Ã¤ritellÃ¤Ã¤n kuten edellisessÃ¤ tehtÃ¤vÃ¤ssÃ¤, eli esimerkiksi `@WebServlet("/list")`-annotaation avulla. 

TÃ¤mÃ¤n sivun ylÃ¤osassa esitetyssÃ¤ esimerkkihakemistorakenteessa tÃ¤mÃ¤n servletin nimi on `ShoppingListServlet`, mutta voit nimetÃ¤ luokan haluamallasi tavalla.

Tarvitset servletissÃ¤ aikaisemmin toteuttamaasi DAO-luokkaa tuotteiden hakemista ja lisÃ¤Ã¤mistÃ¤ varten. LisÃ¤Ã¤ servlet-luokkaan tarvittavat `import`-komennot DAO-luokkaa sekÃ¤ model-luokkaa varten.

`doGet`-metodin on tarkoitus hakea kaikki ostoslistan tuoterivit listana. Sen jÃ¤lkeen servletin tulee vÃ¤littÃ¤Ã¤ kyseinen lista seuraavassa osassa toteutettavalle JSP-sivulle `setAttribute`-metodin avulla. [TÃ¤mÃ¤ YouTube-video](https://youtu.be/R0EnI9_ZMA0) havainnollistaa listan vÃ¤littÃ¤misen JSP-sivulle sekÃ¤ listan kÃ¤yttÃ¤misen tagikirjaston avulla.


### Osa 2: Toteuta JSP-sivu ostoslistan sisÃ¤llÃ¶n esittÃ¤mistÃ¤ varten

Toteuta tietokannasta haettujen ostoslistan tuoterivien nÃ¤yttÃ¤miseksi uusi JSP-sivu. YllÃ¤ esimerkkihakemistorakenteessa tÃ¤mÃ¤n sivun tiedostonimi on `list.jsp`, mutta voit nimetÃ¤ tiedoston myÃ¶s muulla tavalla. TÃ¤llÃ¤ JSP-sivulla tarvitset aikaisemmin asentamaasi **JSTL-kirjastoa**, joka otetaan kÃ¤yttÃ¶Ã¶n sivulla `taglib`-direktiivin avulla:

```jsp
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
```

YlempÃ¤nÃ¤ sivulta lÃ¶ytyvÃ¤ video 2 nÃ¤yttÃ¤Ã¤, miten ostoslista voidaan kÃ¤ydÃ¤ lÃ¤pi `c:forEach`-tagin avulla ja miten tuoterivit tulostetaan turvallisesti `c:out`-tagin avulla.

Sivun HTML-rakenteella ei ole tÃ¤mÃ¤n tehtÃ¤vÃ¤n kannalta suurta merkitystÃ¤, kunhan ratkaisusi on jÃ¤rkevÃ¤Ã¤ HTML-koodia. Voit nÃ¤yttÃ¤Ã¤ ostoslistan sisÃ¤llÃ¶n valintasi mukaan esimerkiksi `<ul>`- ja `<li>`-listaelementeillÃ¤ ([ohje](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/li)):

```html
<!-- lista -->
<ul>
    <!-- TODO: NÃ¤mÃ¤ rivit tulee generoida c:forEach- ja c:out-tagien avulla -->
    <li>Milk</li>
    <li>Eggs</li>
</ul>
```

Vaihtoehtoisesti voit luoda `<table>`-taulukkorakenteen esimerkiksi seuraavasti ([ohje](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/table)):

```html
<!-- taulukko -->
<table>
    <thead>
        <tr><th>Product</th></tr>
    </thead>
    <tbody>
        <!-- TODO: NÃ¤mÃ¤ rivit tulee generoida c:forEach- ja c:out-tagien avulla -->
        <tr><td>Milk</td></tr>
        <tr><td>Eggs</td></tr>
    </tbody>
</table>
```

### Injektioilta suojautuminen (Cross Site Scripting, XSS)

SQL-aiheen yhteydessÃ¤ kÃ¤ytimme `PreparedStatement`-luokkaa vÃ¤lttÃ¤Ã¤ksemme tekstidatan tulkitsemisen SQL-lausekkeina (SQL-injektio). Koska **ostoslistan tuotteet ovat kÃ¤yttÃ¤jien syÃ¶ttÃ¤mÃ¤Ã¤ dataa, myÃ¶s ne saattavat sisÃ¤ltÃ¤Ã¤ mitÃ¤ tahansa merkkijonoja**. On siis mahdollista, ettÃ¤ kÃ¤yttÃ¤jÃ¤ kirjoittaa tuotteen nimeen **esimerkiksi HTML- tai JavaScript-koodia**, joka muuttaa sivun sisÃ¤ltÃ¶Ã¤ haitallisesti toisen kÃ¤yttÃ¤jÃ¤n avatessa sivua. TÃ¤stÃ¤ haavoittuvuudesta kÃ¤ytetÃ¤Ã¤n termiÃ¤ Cross Site Scripting (XSS). Voit lukea aiheesta lisÃ¤Ã¤ [Open Web Application Security Project -projektin sivuilla (OWASP)](https://owasp.org/www-community/attacks/xss/).

HTML-koodin yhteydessÃ¤ onkin erittÃ¤in tÃ¤rkeÃ¤Ã¤ huolehtia siitÃ¤, ettÃ¤ kaikki dynaaminen teksti enkoodataan siten, ettÃ¤ esimerkiksi kulmasulkeita `<` ja `>` ei tulkita osaksi HTML-tageja, vaan pelkiksi kirjainmerkeiksi. `c:out`-tagi huolehtii juuri tÃ¤stÃ¤ ja muuttaa esimerkiksi `<`-merkin ns. HTML-entiteetiksi `&lt;`, jonka selain tulkitsee aina kirjainmerkiksi.

> *"An HTML entity is a piece of text ("string") that begins with an ampersand (&) and ends with a semicolon (;) . Entities are frequently used to display reserved characters (which would otherwise be interpreted as HTML code), and invisible characters (like non-breaking spaces)."*
>
> MDN web docs. Entity. [https://developer.mozilla.org/en-US/docs/Glossary/Entity](https://developer.mozilla.org/en-US/docs/Glossary/Entity)

Esimerkiksi haitallista koodia sisÃ¤ltÃ¤vÃ¤ tuotenimi `"Milk <script>alert('attack!');</script>"` ei siis saa tuottaa HTML-sivulle seuraavaa sisÃ¤ltÃ¶Ã¤:

<pre class="highlight" style="border: solid red 2px; color: red;"><code>&lt;li&gt;
    Milk <span style="color: red">&lt;script&gt;alert('attack!');&lt;/script&gt;</span>
&lt;/li&gt;</code></pre>

YllÃ¤ oleva koodi sisÃ¤ltÃ¤Ã¤ sivulle kuulumatonta JavaScriptiÃ¤, joka voi huonossa tapauksessa esimerkiksi kaapata kÃ¤yttÃ¤jÃ¤n istunnon tai suorittaa sivustolla toimenpiteitÃ¤ kÃ¤yttÃ¤jÃ¤n nimissÃ¤.

Merkkijonot tuleekin aina kÃ¤sitellÃ¤ `c:out`-tagin avulla, jolloin niissÃ¤ mahdollisesti olevat HTML-rakenteet muutetaan erikoismerkeiksi, jotka selain osaa tulkita tavallisena tekstinÃ¤:

```html
<li>
    <c:out value="${ item.getTitle() }" />
</li>
```

```html
<li>
    Milk &lt;script&gt;alert(&#039;attack!&#039;);&lt;/script&gt;
</li>
```

Selain tulkitsee yllÃ¤ olevasta koodista `c:out`-tagin ulkopuoliset `<li>`-elementit HTML-koodina, mutta `c:out`-tagin tuottama `&lt;` nÃ¤ytetÃ¤Ã¤n sivulla tavallisena turvallisena "pienempi kuin"-merkkinÃ¤.

Lue myÃ¶s tarvittaessa keskustelu aiheesta ["what exactly does the &lt;c:out&gt; do?"](https://stackoverflow.com/q/291031)


### Osa 3: Toteuta lomake ja `doPost`-metodi uuden rivin lisÃ¤Ã¤miseksi ostoslistalle

Viimeiseksi tarvitsemme vielÃ¤ lomakkeen uusien tuoterivien lisÃ¤Ã¤miseksi listalle, sekÃ¤ kÃ¤sittelijÃ¤n, joka vastaanottaa lomakkeen tiedot ja kutsuu dao-luokan tallennusoperaatiota.

Voit lisÃ¤tÃ¤ lomakkeen samalle JSP-sivulle, jolla nÃ¤ytÃ¤t myÃ¶s tuotelistan. Lomakkeen HTML-koodiksi sopii esimerkiksi seuraava koodinpÃ¤tkÃ¤:

```html
<form method="post">
    <input name="title" type="text" required placeholder="type item here..." autofocus /> 
    <input type="submit" value="Add to list" />
</form>
```

Valmis lomake nÃ¤yttÃ¤Ã¤ suurin piirtein seuraavalta:

<form method="post" action="http://localhost:8080/list">
    <fieldset>
        <legend>Esimerkki lomakkeesta:</legend>
        <input name="title" type="text" required placeholder="type item here..." /> 
        <input type="submit" value="Add to list" />
    </fieldset>
</form>

<!--Esimerkin `form`-tagilla ei ole `action`-attribuuttia, joten sen lÃ¤hettÃ¤minen tekee `post`-tyyppisen HTTP-pyynnÃ¶n samaan osoitteeseen, josta sivu on ladattu. Voit tarvittaessa mÃ¤Ã¤ritellÃ¤ eri osoitteen lisÃ¤Ã¤mÃ¤llÃ¤ `action`-attribuutin.-->

Kun lomake lÃ¤hetetÃ¤Ã¤n, HTTP-pyynnÃ¶n mukana vÃ¤litetÃ¤Ã¤n kÃ¤yttÃ¤jÃ¤n kirjoittama teksti. Kunkin tekstikentÃ¤n sisÃ¤ltÃ¶ on palvelimella kÃ¤siteltÃ¤vissÃ¤ sillÃ¤ nimellÃ¤, joka on mÃ¤Ã¤ritetty kyseisen tekstikentÃ¤n `name`-attribuutin arvoksi:

```html
<input name="title" />
```

YllÃ¤ tekstikentÃ¤n nimeksi on asetettu on `"title"`, joten siihen syÃ¶tetty teksti saadaan servletissÃ¤ luettua esimerkiksi seuraavasti:

```java
String itemTitle = req.getParameter("title");
```

Voit lukea lisÃ¤Ã¤ HTML-lomakkeiden lÃ¤hettÃ¤misestÃ¤ artikkelista ["Sending form data" (MDN web docs)](https://developer.mozilla.org/en-US/docs/Learn/Forms/Sending_and_retrieving_form_data).

### Lomaketietojen kÃ¤sitteleminen palvelimella

Lomakkeen lÃ¤hetyksen jÃ¤lkeen se kÃ¤sitellÃ¤Ã¤n palvelimella joko `doGet` tai `doPost`-kÃ¤sittelijÃ¤metodilla. KÃ¤ytettÃ¤vÃ¤ metodi riippuu siitÃ¤, mikÃ¤ HTTP-metodi on mÃ¤Ã¤ritetty sivun lomakkeelle. TÃ¤ssÃ¤ tehtÃ¤vÃ¤ssÃ¤ lomake lÃ¤hetetÃ¤Ã¤n post-metodilla:

```html
<form method="post">
    <!-- lomakkeen sisÃ¤ltÃ¶ -->
</form>
```

Jos et mÃ¤Ã¤rittele lomakkeelle valinnaista `action`-attribuuttia, lÃ¤hetetÃ¤Ã¤n pyyntÃ¶ samaan osoitteeseen josta kyseinen HTML-sivu ladattiin. MeidÃ¤n tapauksessamme emme mÃ¤Ã¤rittele action-attribuuttia, joten pyyntÃ¶ pÃ¤Ã¤tyy samalle servletille, mutta tÃ¤llÃ¤ kertaa `doPost`-metodiin.

LisÃ¤Ã¤ lomakkeella lÃ¤hetettyjen tietojen kÃ¤sittelemiseksi omaan servlettiisi uusi `doPost`-metodi, joka lukee parametrina lÃ¤hetetyn tuotenimen ja lisÃ¤Ã¤ tietokantaan uuden tuoterivin kyseisellÃ¤ nimellÃ¤. Huom! Noudata MVC-mallia ja hyÃ¶dynnÃ¤ DAO-luokkaa, Ã¤lÃ¤kÃ¤ tee tietokantaoperaatiota servlet-luokassasi:

```java
public void doPost(HttpServletRequest req, HttpServletResponse resp) throws IOException {
    // todo: hae tuotteen  nimi req-objektilta
    // todo: kÃ¤ytÃ¤ tuotenimeÃ¤ luodaksesi uuden ShoppingListItem-olion
    // todo: tallenna luomasi olio tietokantaan DAO-luokkasi avulla
}
```

### Bonus: uudelleenohjaus POST-pyynnÃ¶n jÃ¤lkeen (Post/Redirect/Get)

Onnistuneen POST-tyyppisen lomakkeen lÃ¤hetyksen jÃ¤lkeen on aina hyvÃ¤ tehdÃ¤ uudelleenohjaus, eli pyytÃ¤Ã¤ selainta lataamaan sivu GET-pyynnÃ¶llÃ¤. TÃ¤llÃ¤ tavoin kÃ¤yttÃ¤jÃ¤ ei voi esimerkiksi vahingossa kÃ¤yttÃ¤Ã¤ selaimensa pÃ¤ivitÃ¤-toimintoa tai sivuhistoriaa ja toistaa POST-tyyppistÃ¤ kutsua, joka saattaisi luoda esimerkiksi tietokantaan saman rivin uudelleen:

> "*The post / redirect / get pattern or PRG pattern is a development approach that prevents duplicate content when submitting forms and provides a more intuitive user interface. The post-redirect-get pattern allows you to set bookmarks, share URLs, and reload a website that queries and sends form data - without creating duplicate content or near duplicate content.*"
>
> *Ryte Wiki. Post-Redirect-Get. [https://en.ryte.com/wiki/Post-Redirect-Get](https://en.ryte.com/wiki/Post-Redirect-Get)*


POST-pyyntÃ¶ihin vastaamista uudelleenohjauksilla kutsutaan osuvasti nimellÃ¤ ["Post/Redirect/Get"](https://en.wikipedia.org/wiki/Post/Redirect/Get)". Selaimen uudelleenohjauksen voi kÃ¤ytÃ¤nnÃ¶ssÃ¤ toteuttaa servletissÃ¤ `HttpServletResponse`-olion `sendRedirect`-metodilla seuraavasti:

```java
resp.sendRedirect("/polku/johon/ohjataan");
```

KÃ¤ytÃ¤nnÃ¶ssÃ¤ `"/polku/johon/ohjataan"` on tyypillisesti sama polku, joka on mÃ¤Ã¤ritetty servletin osoitteeksi `@WebServlet`-annotaatiolla.

---

### Loppusanat

Olemme nyt jatkokehittÃ¤neet aikaisemmin toteuttamamme komentorivikÃ¤yttÃ¶liittymÃ¤llÃ¤ toimivan logiikan web-sovellukseksi. Ohjelmiston tarkoituksenmukainen rakenne on mahdollistanut koodin hyÃ¶dyntÃ¤misen erilaisissa kÃ¤yttÃ¶tarkoituksissa.

Jotta ohjelma olisi lopulta hyÃ¶dyllinen ostoslistasovellus, siihen tulisi vielÃ¤ lisÃ¤tÃ¤ lukuisia ominaisuuksia, kuten tuoterivin poistaminen. Tutustumme hieman myÃ¶hemmin myÃ¶s `doDelete`-metodiin, jonka avulla toteutamme rivien poistamisen ostoslistalta.


<script src="/scripts.js"></script>